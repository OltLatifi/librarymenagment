@using Microsoft.AspNetCore.Identity
@model librarymenagment.Models.Book
@inject UserManager<IdentityUser> UserManager

@{
    ViewData["Title"] = "Details";
}

<h1>Details</h1>

<div>
    <h4>Book</h4>
    <hr />
    <dl class="row">
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Title)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Title)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Description)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Description)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Copies)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Copies)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Author)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Author.Name)
            @Html.DisplayFor(model => model.Author.LastName)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Category)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Category.Name)
        </dd>
                <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.CreatedAt)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.CreatedAt)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.UpdatedAt)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.UpdatedAt)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Active)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Active)
        </dd>
    </dl>
</div>
<div>
    <a asp-area="Admin" asp-action="Edit" asp-route-id="@Model?.Id">Edit</a> |
    <a asp-area="Admin" asp-action="Index">Back to List</a>
</div>
<div class="mt-6">
	<h3>Comments</h3>
    <div id="comments-list">
        <p>No comments</p>
    </div>
    <form id="CommentForm" method="post">
        <input type="text" name="Comment" value="" />
		<button>Submit</button>
    </form>
</div>

@section Scripts {
    <script>
        const currentUserEmail = "@UserManager.GetUserAsync(User).Result?.Email";

        function addComments(data) {
            function addComment(comment) {
                const isAuthor = comment.user.email === currentUserEmail;
                const actionButtons = isAuthor ? `
                    <div class="comment-actions">
                        <button onclick="toggleEditMode(${comment.id})">Edit</button>
                        <button onclick="deleteComment(${comment.id})">Delete</button>
                    </div>
                    <div class="edit-form-${comment.id}" style="display: none;">
                        <input type="text" value="${comment.description}" class="edit-input-${comment.id}"/>
                        <button onclick="submitEdit(${comment.id})">Save</button>
                        <button onclick="toggleEditMode(${comment.id})">Cancel</button>
                    </div>
                ` : '';

                $("#comments-list").append(`
                    <div class="comment-${comment.id}">
                        <h4>${comment.user.email}</h4>
                        <p class="comment-text-${comment.id}">${comment.description}</p>
                        ${actionButtons}
                    </div>
                `);
            }
            
            if (data.length > 0) {
                $("#comments-list").empty();
                data.map(el => addComment(el));
            } else {
                $("#comments-list").html("<p>No comments</p>");
            }
        }

        function toggleEditMode(commentId) {
            $(`.edit-form-${commentId}`).toggle();
            $(`.comment-text-${commentId}`).toggle();
        }

        function submitEdit(commentId) {
            const newDescription = $(`.edit-input-${commentId}`).val();
            updateComment(commentId, newDescription);
        }

        function getComments(){
             $.ajax({
                url: "/api/Comments?bookId=" + @Model?.Id,
                type: "GET",
                success: function (data) {
                    addComments(data);
                }
            });
        }

        function deleteComment(id){
            $.ajax({
                url: "/api/Comments?id=" + id,
                type: "DELETE",
                success: function (data) {
                    getComments();
                }
            });
        }

        function updateComment(id, description){
            $.ajax({
                url: "/api/Comments?id=" + id,
                type: "PUT",
                data: { description: description },
                success: function (data) {
                    getComments();
                }
            });
        }

	    $(document).ready(function () {
			getComments();

			$("#CommentForm").submit(function (e) {
				e.preventDefault();
                const payload = {
                    BookId: @Model?.Id,
                    Description: $("input[name='Comment']").val(),
                    Active: true,
                }
				$.ajax({
					url: "/api/Comments",
					type: "POST",
                    contentType: "application/json",
					data: JSON.stringify(payload),
					success: function (data) {
                       getComments();
					}
				});
			});
	    });
    </script>
}